
module NamelistHelpers

using NCDatasets
using MITgcmTools

export update_param
export update_tracer
export update_tracers
export dar_one_run
export tracer_id_to_name
export tracer_name_to_id
export update_diagnostic_freq
export update_temperature

function update_param(file_name, group_name, param_name, new_param_value, config_obj)
    rundir = joinpath(config_obj.folder, config_obj.ID, "run")
    # read the contents of the data file into a namelist 
    data_file = file_name
    fil = joinpath(rundir, data_file)
    nml = read(fil, MITgcm_namelist())

    # which param group do you want to modify?
    nmlgroup = group_name
    group_idx =findall(nml.groups.==Symbol(nmlgroup))[1]
    parms = nml.params[group_idx]

    # what parameter do you want to modify?
    p_name = param_name
    p_value = new_param_value

    # write changed parameter
    # tmptype= haskey(nml.params[group_idx], Symbol(p_name)) ? typeof(nml.params[group_idx][Symbol(p_name)]) : typeof(p_value)
    #nml.params[group_idx][Symbol(p_name)]=parse(tmptype,p_value)
    nml.params[group_idx][Symbol(p_name)] = p_value
    tmpfil=joinpath(rundir,data_file)
    rm(tmpfil)
    write(tmpfil,nml)
    tmpfil=joinpath("tracked_parameters",data_file)
    # ClimateModels.git_log_fil(config_obj,tmpfil,"updated $(p_name) parameter file in $(data_file) to $(p_value)")
end # update_param

"""
common time steps in seconds 
"""
@enum SECONDS begin
    one_week=604800 
    two_weeks=604800*2
    month = 2592000
end # enum 

# TODO: create enums for diagnostic names (and name them better?)
# TODO: what should the initial frequency be? - in file
function update_diagnostic_freq(diagnostic_num, frequency, config_obj)
    update_param("data.diagnostics", "diagnostics_list", "frequency($diagnostic_num)", frequency, config_obj)
end

function update_temperature(new_temp, config_obj)
    update_param("data", "PARM01", "tRef", new_temp, config_obj)
end

"""
    tracer_id_to_name(id)

Return the string "TRAC"+id      
"""
function tracer_id_to_name(id)
    tracer_id = length(string(id)) < 2 ? "0"*string(id) : string(id)
    tracer_name = "TRAC"*tracer_id 
    return tracer_name
end

"""
    tracer_name_to_id(name)
    
Return the int in the tracer name. i.e. tracer_name_to_id("TRAC21") will return 21      
"""
function tracer_name_to_id(name)
    return parse(Int64, name[5:6])
end

function update_tracer(tracer_num::Int64, new_value::Float32, config_obj)
    update_param("data.ptracers", "PTRACERS_PARM01", "PTRACERS_ref( :,$tracer_num)", new_value, config_obj)
end

function update_tracer(tracer_num::Int64, new_value::Float64, config_obj)
    update_param("data.ptracers", "PTRACERS_PARM01", "PTRACERS_ref( :,$tracer_num)", new_value, config_obj)
end

function update_tracers(tracer_ids, ds::NCDataset, x, y, z, t, config_obj, multiplier=1)
    for tracer_id in tracer_ids
        tracer_name = tracer_id_to_name(tracer_id)
        update_tracer(tracer_id, ds[tracer_name][x,y,z,t]*multiplier, config_obj)
    end
end

function dar_one_run(config_obj)
    println("launching... on thread $(Threads.threadid())")
    t = @elapsed begin
        MITgcm_launch(config_obj)
    end
    println("run completed")
    println("time elapse: ", t, " seconds")
    println()
    # println("Output in directory $rundir, most recent ecco folder ")
    # TODO: print out the subfolder (i.e. "ecco_gud_DATE_0001")
end

# nutrients (name -> tracer id)
@enum TRACER_IDS begin
    # DIC = "TRAC01"
    # NO3 = "TRAC02"
    # NO3 = "TRAC03"
    # NH4 = "TRAC04"
    # PO4 = "TRAC05"
    # FeT = "TRAC06"
    # SiO2 = "TRAC07"
    # DOC = "TRAC08"
    # DON = "TRAC09"
    # DOP = "TRAC10"
    # DOFe = "TRAC11"
    # POC = "TRAC12"
    # PON = "TRAC13" 
    # POP = "TRAC14"
    # POFe  = "TRAC15"
    # POSi = "TRAC16"
    # PIC = "TRAC17"
    # ALK = "TRAC18"
    # O2 = "TRAC19"
    # CDOM = "TRAC20"
    DIC = 1
    NO3 = 2
    NO2 = 3
    NH4 = 4
    PO4 = 5
    FeT = 6
    SiO2 = 7
    DOC = 8
    DON = 9
    DOP = 10
    DOFe = 11
    POC = 12
    PON = 13 
    POP = 14
    POFe  = 15
    POSi = 16
    PIC = 17
    ALK = 18
    O2 = 19
    CDOM = 20
end

end # module 
